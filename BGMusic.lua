local song = {
  default = {
    path = "Interface\\AddOns\\BGMusic\\Tearing_Through_Heaven.mp3",
    duration = 131
  },
  boss = {
    -- sl single raid boss
    guardian_vigilante = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    dausegne_oraculo_caida = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    artificiero_xymox = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    panteon_prototipo = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    skolex_devorador_insaciable = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    halondrus_recolector = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    lihuvim_arquitecto_principal = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    anduin_wrynn = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    senyores_terror = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    rygelon = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    carcelero = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    -- sl single dungeon boss
    soleah = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
    capitana_colagarfio = {
      path = "Interface\\AddOns\\BGMusic\\Lets_Battle_Mix.mp3",
      duration = 245
    },
    

    -- bfa single raid boss 
    jaina = {
      path = "Interface\\AddOns\\BGMusic\\Let-It-Go-Winter.mp3",
      duration = 229
    },
    
    -- bfa single dungeon boss
    sethraliss = {
      path = "Interface\\AddOns\\BGMusic\\bioinformatics.mp3",
      duration = 128
    },
    
    -- legion single dungeon boss
    archidruida_glaidalis = {
      path = "Interface\\AddOns\\BGMusic\\arboleda_corazon_oscuro.mp3",
      duration = 139
    },
    corazon_de_roble = {
      path = "Interface\\AddOns\\BGMusic\\arboleda_corazon_oscuro.mp3",
      duration = 139
    },
    dresaron = {
      path = "Interface\\AddOns\\BGMusic\\arboleda_corazon_oscuro.mp3",
      duration = 139
    },
    sombra_de_xavius = {
      path = "Interface\\AddOns\\BGMusic\\arboleda_corazon_oscuro.mp3",
      duration = 139
    },
    cordana = {
      path = "Interface\\AddOns\\BGMusic\\moon_river.mp3",
      duration = 510
    },
    
    -- sl dungeon boss
    teatro_dolor = {
      path = "Interface\\AddOns\\BGMusic\\The_Verge_of_Death_(Rain).mp3",
      duration = 171
    },
    peste_abrumadora = {
      path = "Interface\\AddOns\\BGMusic\\The_Verge_of_Death_(Rain).mp3",
      duration = 171
    },
    destruccion_necrotica = {
      path = "Interface\\AddOns\\BGMusic\\Koloktos_Moldarach.mp3",
      duration = 161
    },
    profundidades_sanguineas = {
      path = "Interface\\AddOns\\BGMusic\\Lost_Again.mp3",
      duration = 310
    },
    salones_expiacion = {
      path = "Interface\\AddOns\\BGMusic\\Lost_Again.mp3",
      duration = 310
    },
    torres_ascencion = {
      path = "Interface\\AddOns\\BGMusic\\Koloktos_Moldarach.mp3",
      duration = 161
    },
    tirna_scithe = {
      path = "Interface\\AddOns\\BGMusic\\Decisive_Battle_I.mp3",
      duration = 266
    },
    el_otro_lado = {
      path = "Interface\\AddOns\\BGMusic\\Where_Is_Your_God_Now.mp3",
      duration = 109
    },
    torghast = {
      path = "Interface\\AddOns\\BGMusic\\therion-blood-of-kingu.mp3",
      duration = 332
    },
    tazavesh = {
      path = "Interface\\AddOns\\BGMusic\\11_Bowsers_Fury.mp3",
      duration = 232
    },
    -- sl raid boss
    castillo_nathria = {
      path = "Interface\\AddOns\\BGMusic\\Raid.mp3",
      duration = 216
    },
    sagrario_dominacion = {
      path = "Interface\\AddOns\\BGMusic\\08_minos.mp3",
      duration = 116
    },
    sepulcro_primeros = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },

    --bfa dungeon boss
    mansion_tarjasenda = {
      path = "Interface\\AddOns\\BGMusic\\song(xepher).mp3",
      duration = 216
    },
    filon = {
      path = "Interface\\AddOns\\BGMusic\\l4d_concert.mp3",
      duration = 265
    },
    templo_sethraliss = {
      path = "Interface\\AddOns\\BGMusic\\bioinformatics.mp3",
      duration = 128
    },
    bardoma = {
      path = "Interface\\AddOns\\BGMusic\\windowless_building.mp3",
      duration = 260
    },
    puerto_libre = {
      path = "Interface\\AddOns\\BGMusic\\Lets_Battle_Mix.mp3",
      duration = 245
    },
    santuario_tormenta = {
      path = "Interface\\AddOns\\BGMusic\\underground_cave.mp3",
      duration = 153
    },
    
    --bfa raid boss
    dazaralor = {
      path = "Interface\\AddOns\\BGMusic\\full_circle.mp3",
      duration = 85
    },


    default_boss = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    }
  },
  instance = {
    -- sl dungeon
    teatro_dolor = {
      path = "Interface\\AddOns\\BGMusic\\Shambhala_(Thunder).mp3",
      duration = 189
    },
    peste_abrumadora = {
      path = "Interface\\AddOns\\BGMusic\\Shambhala_(Thunder).mp3",
      duration = 189
    },
    destruccion_necrotica = {
      path = "Interface\\AddOns\\BGMusic\\The_Shackled_Wolves_(Rain).mp3",
      duration = 353
    },
    profundidades_sanguineas = {
      path = "Interface\\AddOns\\BGMusic\\Wine_Of_Aluqah.mp3",
      duration = 282
    },
    salones_expiacion = {
      path = "Interface\\AddOns\\BGMusic\\Wine_Of_Aluqah.mp3",
      duration = 282
    },
    torres_ascencion = {
      path = "Interface\\AddOns\\BGMusic\\Tempest_of_Seasons_(Rain).mp3",
      duration = 307
    },
    tirna_scithe = {
      path = "Interface\\AddOns\\BGMusic\\Dwellings_of_the_Ancient_Gods_(Thunder).mp3",
      duration = 317
    },
    el_otro_lado = {
      path = "Interface\\AddOns\\BGMusic\\Tribal_Metal_-_Spirit_War.mp3",
      duration = 199
    },
    torghast = {
      path = "Interface\\AddOns\\BGMusic\\therion-blood-of-kingu.mp3",
      duration = 332
    },
    tazavesh = {
      path = "Interface\\AddOns\\BGMusic\\Aruh_Metal_Slug_X_Judgement.mp3",
      duration = 162
    },
    -- sl raid
    castillo_nathria = {
      path = "Interface\\AddOns\\BGMusic\\At_What_Cost_(Rain).mp3",
      duration = 349
    },
    sagrario_dominacion = {
      path = "Interface\\AddOns\\BGMusic\\04_dante_casarma_treloch.mp3",
      duration = 88
    }, 
    sepulcro_primeros = {
      path = "Interface\\AddOns\\BGMusic\\bosses.mp3",
      duration = 103
    },
  
    -- bfa dungeon
    mansion_tarjasenda = {
      path = "Interface\\AddOns\\BGMusic\\mansion_tarjasenda.mp3",
      duration = 143
    },
    filon = {
      path = "Interface\\AddOns\\BGMusic\\lili_club.mp3",
      duration = 271
    },
    templo_sethraliss = {
      path = "Interface\\AddOns\\BGMusic\\bacterion.mp3",
      duration = 106
    },
    bardoma = {
      path = "Interface\\AddOns\\BGMusic\\cenotaph.mp3",
      duration = 119
    },
    puerto_libre = {
      path = "Interface\\AddOns\\BGMusic\\Karakuri_Defense_System_Activate.mp3",
      duration = 204
    },
    santuario_tormenta = {
      path = "Interface\\AddOns\\BGMusic\\windowless_building.mp3",
      duration = 260
    },
    -- bfa raid
    dazaralor = {
      path = "Interface\\AddOns\\BGMusic\\battle_lusamine.mp3",
      duration = 179
    }
  }
}

local boss = {
  -- sl single raid boss
  guardian_vigilante = {
    npc_id = 180773,
    encounterID = 2512
  },
  dausegne_oraculo_caida = {
    npc_id = 181224,
    encounterID = 2540
  },
  artificiero_xymox = {
    npc_id = 183501,
    encounterID = 2553
  },
  panteon_prototipo = {
    npc_id = 181549,
    encounterID = 2544
  },
  skolex_devorador_insaciable = {
    npc_id = 183937,
    encounterID = 2542
  },
  halondrus_recolector = {
    npc_id = 184915,
    encounterID = 2529
  },
  lihuvim_arquitecto_principal = {
    npc_id = 182169,
    encounterID = 2539
  },
  anduin_wrynn = {
    npc_id = 181954,
    encounterID = 2546
  },
  senyores_terror = {
    npc_id = 26533,
    encounterID = 2543
  },
  rygelon = {
    npc_id = 182777,
    encounterID = 2549
  },
  carcelero = {
    npc_id = 185421,
    encounterID = 2537
  },
  -- sl single dungeon boss
  soleah = {
    npc_id = 180863,
    encounterID = 2442
  },
  capitana_colagarfio = {
    npc_id = 175546,
    encounterID = 2419
  },

  -- bfa raid boss
  jaina = {
    npc_id = 149684,
    encounterID = 2281
  },
  
  -- bfa dungeon boss
  sethraliss = {
    npc_id = 133392,
    encounterID = 2127
  },
  
  -- legion dungeon boss
  cordana = {
    npc_id = 95888,
    encounterID = 1818
  },
  archidruida_glaidalis = {
    npc_id = 96512,
    encounterID = 1836
  },
  corazon_de_roble = {
    npc_id = 103344,
    encounterID = 1837
  },
  dresaron = {
    npc_id = 99200,
    encounterID = 1838
  },
  sombra_de_xavius = {
    npc_id = 99192,
    encounterID = 1839
  }
}

local instance = {
  -- sl dungeon
  teatro_dolor = {
    instanceID = 2293
  },
  peste_abrumadora = {
    instanceID = 2289
  },
  destruccion_necrotica = {
    instanceID = 2286
  },
  profundidades_sanguineas = {
    instanceID = 2284
  },
  salones_expiacion = {
    instanceID = 2287
  },
  torres_ascencion = {
    instanceID = 2285
  },
  el_otro_lado = {
    instanceID = 2291
  },
  tirna_scithe = {
    instanceID = 2290
  },
  torghast = {
    instanceID = 2162
  },
  tazavesh = {
    instanceID = 2441
  },
  -- sl raid
  castillo_nathria = {
    instanceID = 2296
  },
  sagrario_dominacion = {
    instanceID = 2450
  },
  sepulcro_primeros = {
    instanceID = 2481
  },
  
  -- bfa dungeon
  ataldazar = {
    instanceID = 1763
  },
  puerto_libre = {
    instanceID = 1754
  },
  descanso_reyes = {
    instanceID = 1762
  },
  santuario_tormenta = {
    instanceID = 1864
  },
  boralus = {
    instanceID = 1822
  },
  templo_sethraliss = {
    instanceID = 1877
  },
  filon = {
    instanceID = 1594
  },
  bardoma = {
    instanceID = 1841
  },
  mansion_tarjasenda = {
    instanceID = 1862
  },
  -- bfa raid
  uldir = {
    instanceID = 1861
  },
  dazaralor = {
    instanceID = 2070
  }
}

local friend_units = {
  "player",
  "party1",
  "party2",
  "party3",
  "party4",
  "party5"
}
local is_played = nil
local id_handler = nil
local current_playing = false
local current_song = {
  path = nil,
  duration = 0
}
local time_now = nil
local on_battle = false
local boss_fight = false
local id_fight_encounter = nil
local battle_music, battle_events = CreateFrame("Frame"), {}

battle_music:SetScript("OnEvent", function(self, event, ...)
  battle_events[event](self, ...)
end)

function battle_events:PLAYER_REGEN_DISABLED(event)
  print("PLAYER_REGEN_DISABLED")
  on_battle = true
  if current_playing == true then
    if id_handler ~= nil then
      StopSound(id_handler)
      current_playing = false
      current_song.path = nil
      current_song.duration = 0
    end
  end
  selecting_song()
end

function battle_events:ENCOUNTER_START(encounterID, name, difficulty, size)
  print("ENCOUNTER_START ", encounterID, name, difficulty, size)
  boss_fight = true
  on_battle = true
  id_fight_encounter = tonumber(encounterID)
  if current_playing == true then
    if id_handler ~= nil then
      StopSound(id_handler)
      current_playing = false
      current_song.path = nil
      current_song.duration = 0
    end
  end
  selecting_song()
end

function battle_events:PLAYER_REGEN_ENABLED(event)
  print("PLAYER_REGEN_ENABLED")
  on_battle = false
  id_fight_encounter = nil
  if current_playing == true then
    if id_handler ~= nil then
      StopSound(id_handler)
      current_playing = false
      current_song.path = nil
      current_song.duration = 0
    end
  end
end

function battle_events:ENCOUNTER_END(encounterID, name, difficulty, size, success)
  print("ENCOUNTER_END ", encounterID, name, difficulty, size, success)
  boss_fight = false
  on_battle = false
  id_fight_encounter = nil
  if current_playing == true then
    if id_handler ~= nil then
      StopSound(id_handler)
      current_playing = false
      current_song.path = nil
      current_song.duration = 0
    end
  end
end

function battle_events:UNIT_AURA(unit)
  if on_battle then
    if unit == "player" then
      local time_added = time_now + current_song.duration
      local time_temp = time()
      if time_temp >= time_added then
        current_playing = false
        selecting_song()
      end
    end
  end
end

function battle_events:PLAYER_TARGET_CHANGED(typeTriggeredTarget)
  if on_battle then
    local time_added = time_now + current_song.duration
    local time_temp = time()
    if time_temp >= time_added then
      current_playing = false
      selecting_song()
    end
  end
end

-- UNIT_SPELLCAST_START

function selecting_song()
  if false then
  
  -- sl raid boss
  elseif boss_filter(boss.guardian_vigilante) then
    battle_play_file(song.boss.guardian_vigilante)
  elseif boss_filter(boss.dausegne_oraculo_caida) then
    battle_play_file(song.boss.dausegne_oraculo_caida)
  elseif boss_filter(boss.artificiero_xymox) then
    battle_play_file(song.boss.artificiero_xymox)
  elseif boss_filter(boss.panteon_prototipo) then
    battle_play_file(song.boss.panteon_prototipo)
  elseif boss_filter(boss.skolex_devorador_insaciable) then
    battle_play_file(song.boss.skolex_devorador_insaciable)
  elseif boss_filter(boss.halondrus_recolector) then
    battle_play_file(song.boss.halondrus_recolector)
  elseif boss_filter(boss.lihuvim_arquitecto_principal) then
    battle_play_file(song.boss.lihuvim_arquitecto_principal)
  elseif boss_filter(boss.anduin_wrynn) then
    battle_play_file(song.boss.anduin_wrynn)
  elseif boss_filter(boss.senyores_terror) then
    battle_play_file(song.boss.senyores_terror)
  elseif boss_filter(boss.rygelon) then
    battle_play_file(song.boss.rygelon)
  elseif boss_filter(boss.carcelero) then
    battle_play_file(song.boss.carcelero)
  
  -- sl dungeon boss
  elseif boss_filter(boss.capitana_colagarfio) then
    battle_play_file(song.boss.capitana_colagarfio)
  elseif boss_filter(boss.soleah) then
    battle_play_file(song.boss.soleah)
  
  -- bfa raid boss
  elseif boss_filter(boss.jaina) then
    battle_play_file(song.boss.jaina)
  
  -- bfa dungeon boss
  elseif boss_filter(boss.sethraliss) then
    battle_play_file(song.boss.sethraliss)
  
  -- legion dungeon boss
  elseif boss_filter(boss.cordana) then
    battle_play_file(song.boss.cordana)
  elseif boss_filter(boss.archidruida_glaidalis) then
    battle_play_file(song.boss.archidruida_glaidalis)
  elseif boss_filter(boss.corazon_de_roble) then
    battle_play_file(song.boss.corazon_de_roble)
  elseif boss_filter(boss.dresaron) then
    battle_play_file(song.boss.dresaron)
  elseif boss_filter(boss.sombra_de_xavius) then
    battle_play_file(song.boss.sombra_de_xavius)
  
  -- sl dungeon
  elseif instance_filter(instance.peste_abrumadora.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.peste_abrumadora)
    else
      battle_play_file(song.instance.peste_abrumadora)
    end
  elseif instance_filter(instance.teatro_dolor.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.teatro_dolor)
    else
      battle_play_file(song.instance.teatro_dolor)
    end
  elseif instance_filter(instance.destruccion_necrotica.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.destruccion_necrotica)
    else
      battle_play_file(song.instance.destruccion_necrotica)
    end
  elseif instance_filter(instance.profundidades_sanguineas.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.profundidades_sanguineas)
    else
      battle_play_file(song.instance.profundidades_sanguineas)
    end
  elseif instance_filter(instance.salones_expiacion.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.salones_expiacion)
    else
      battle_play_file(song.instance.salones_expiacion)
    end
  elseif instance_filter(instance.torres_ascencion.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.torres_ascencion)
    else
      battle_play_file(song.instance.torres_ascencion)
    end
  elseif instance_filter(instance.el_otro_lado.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.el_otro_lado)
    else
      battle_play_file(song.instance.el_otro_lado)
    end
  elseif instance_filter(instance.tirna_scithe.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.tirna_scithe)
    else
      battle_play_file(song.instance.tirna_scithe)
    end
  elseif instance_filter(instance.torghast.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.torghast)
    else
      battle_play_file(song.instance.torghast)
    end
  elseif instance_filter(instance.tazavesh.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.tazavesh)
    else
      battle_play_file(song.instance.tazavesh)
    end
  -- sl raid
  elseif instance_filter(instance.castillo_nathria.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.castillo_nathria)
    else
      battle_play_file(song.instance.castillo_nathria)
    end
  elseif instance_filter(instance.sagrario_dominacion.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.sagrario_dominacion)
    else
      battle_play_file(song.instance.sagrario_dominacion)
    end
  
  -- bfa raid
  elseif instance_filter(instance.dazaralor.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.dazaralor)
    else
      battle_play_file(song.instance.dazaralor)
    end

  -- bfa dungeon
  elseif instance_filter(instance.mansion_tarjasenda.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.mansion_tarjasenda)
    else
      battle_play_file(song.instance.mansion_tarjasenda)
    end
  elseif instance_filter(instance.filon.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.filon)
    else
      battle_play_file(song.instance.filon)
    end
  elseif instance_filter(instance.templo_sethraliss.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.templo_sethraliss)
    else
      battle_play_file(song.instance.templo_sethraliss)
    end
  elseif instance_filter(instance.bardoma.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.bardoma)
    else
      battle_play_file(song.instance.bardoma)
    end
  elseif instance_filter(instance.puerto_libre.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.puerto_libre)
    else
      battle_play_file(song.instance.puerto_libre)
    end
  elseif instance_filter(instance.santuario_tormenta.instanceID) then
    if is_boss() then
      battle_play_file(song.boss.santuario_tormenta)
    else
      battle_play_file(song.instance.santuario_tormenta)
    end  

  elseif is_boss() then
    battle_play_file(song.boss.default_boss)

  else
    battle_play_file(song.default)
  end
end

function instance_filter(instance_id)
  local _, _name, _instanceType, _difficultyIndex, _difficultyName, _maxPlayers, _dynamicDifficulty, _isDynamic, instanceMapId, _instanceGroupSize, _LfgDungeonID = pcall(GetInstanceInfo)
  if instance_id == instanceMapId then
    return true
  end
  return false
end

function boss_filter(boss_npc)
  local boss_id = boss_npc.npc_id
  local boss_encounter_id = boss_npc.encounterID
  
  if boss_encounter_id == id_fight_encounter then
    return true
  end
  
  for i = 1, 4 do
    local _, guid = pcall(UnitGUID, "boss" .. i)
    if guid ~= nil then
      local _type, _zero, _server_id, _instance_id, _zone_uid, npc_id, _spawn_uid = strsplit("-", guid)
      npc_id = tonumber(npc_id)
      if boss_id == npc_id then
        return true
      end
    end
  end

  local _, guid = pcall(UnitGUID, "target")
  if guid ~= nil then
    local _type, _zero, _server_id, _instance_id, _zone_uid, npc_id, _spawn_uid = strsplit("-", guid)
    npc_id = tonumber(npc_id)
    if boss_id == npc_id then
      return true
    end
  end

  for i = 1, 4 do
    local _, guid = pcall(UnitGUID, "party" .. i .. "target")
    if guid ~= nil then
      local _type, _zero, _server_id, _instance_id, _zone_uid, npc_id, _spawn_uid = strsplit("-", guid)
      npc_id = tonumber(npc_id)
      if boss_id == npc_id then
        return true
      end
    end
  end

  return false
end

function is_boss()
  for i = 1, 4 do
    local _, boss_detected = pcall(UnitExists, "boss" .. i)
    if ( boss_detected == true or boss_detected == 1 ) then
      boss_fight = true
      return true
    end
  end
  
  for i = 1, 5 do
    local _, friend_detected = pcall(UnitExists, friend_units[i])
    if ( friend_detected == true or friend_detected == 1 ) then
      local _, type_boss = pcall(UnitClassification, friend_units[i] .. "target")
      if ( type_boss == "worldboss" ) then
        boss_fight = true
        return true
      end
    end
  end
  
  if boss_fight == true then
    return true
  end

  return false
end

function battle_play_file(song)
  if current_playing == false then
    is_played, id_handler = PlaySoundFile(song.path, "Ambience")
    if is_played ~= true then
      id_handler = nil
    else
      current_playing = true
      current_song.path = song.path
      current_song.duration = song.duration
      time_now = time()
    end
  end
end

for k, _v in pairs(battle_events) do
  battle_music:RegisterEvent(k) -- Register all events for which handlers have been defined
end
